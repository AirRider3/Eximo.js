<html>
<head>
	<title>Example</title>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="js/jquery-1.9.1.min.js"><\/script>');</script>
	<script src="js/Eximo.min.js"></script>
	<script src="js/CanvasDye.min.js"></script>
	<style>
		body {
			margin: 0;
			padding: 0;
			background-color: #000000;
		}

		canvas {
			background-color: #66CC66;
		}
	</style>
</head>
<body>
	<canvas id="myCanvas" width="920" height="640"></canvas>
	<script>

	$(window).resize(resize)
	window.onorientationchange = resize;
	var w, h;

	// From http://www.paulirish.com/2011/requestanimationframe-for-smart-animating/ by @paul_irish
	window.requestAnimFrame = (function(){
	  return  window.requestAnimationFrame       ||
	          window.webkitRequestAnimationFrame ||
	          window.mozRequestAnimationFrame    ||
	          function( callback ){
	            window.setTimeout(callback, 1000 / 60);
	          };
	})();

    function resize()
	{
		w = window.innerWidth;
		h = window.innerHeight;
		canvas.width = w;
		canvas.height = h;
		mainRender();
	}

	var canvas = document.getElementById('myCanvas');
	var ctx = canvas.getContext('2d');

	var animStates = ['down','downright', 'right', 'upright', 'up', 'upleft', 'left', 'downleft'];
	var gameObjects = [];
	var kipos = [];

	function assetsLoaded () {
		for (var i = 0; i < 50; ++i) {
			var kipo = new KiposController();
			gameObjects.push(kipo);
		}
		gameObjects.sort(function (g1,g2){return g1.y - g2.y;});
		requestAnimFrame(mainLoop);
	}

	// http://bit.ly/VWcExf
	Eximo.loadSpriteSheets(['basic-textures.json'], assetsLoaded);

	function GameObject () {

	}
	GameObject.prototype = {
		x : 0,
		y : 0,
		radius : 20,
		hitTestGameObject : function (g) {
			var radiusSum = this.radius + g.radius;
			return (Math.abs(this.x-g.x) < radiusSum && Math.abs(this.y-g.y) < radiusSum); 
		},
		hitTestOtherGameObject : function () {
			for (var i = 0; i < gameObjects.length; ++i) {
				if (gameObjects[i] != this && this.hitTestGameObject(gameObjects[i])) return true;
			}
			return false;
		},
		logic : function () {},
		render : function (ctx) {},
		generateRandomPosition : function () {
			this.x = Math.random()*canvas.width-canvas.width/2;
			this.y = Math.random()*canvas.height-canvas.height/2;
			if (this.hitTestOtherGameObject()) this.generateRandomPosition();
		}
	};

	function KiposController () {
		this.spriteCache = {};
		this.animFrame = -1;
		this.generateRandomPosition();
		this.color = '#'+Math.floor(Math.random()*16777215).toString(16);
		this.generateSprite();
	}
	KiposController.prototype = new GameObject ();
	KiposController.prototype.logic = function () {
		if (Math.random()>0.99) {
			++this.animFrame;
			this.generateSprite();
		}
	};
	KiposController.prototype.render = function (ctx) {
		Eximo.drawSprite('basic-shadow.png', ctx, this.x, this.y) ;
		ctx.drawImage(this.sprite, this.x, this.y);
	};
	KiposController.prototype.generateSprite = function () {
		if (!this.spriteCache[this.animFrame]) {
			this.sprite = document.createElement('canvas');
			this.sprite.width = this.sprite.height = 80;
			var ctx = this.sprite.getContext('2d');
			var anim = 'sleep';
			if (this.animFrame >= 0) {
				var anim = animStates[this.animFrame%animStates.length];
				if (anim == 'downleft' || anim == 'left' || anim == 'upleft') {
					//We don't have sprites facing the left side. Use a flipped version of the right ones.
					anim = anim.replace('left', 'right');
					ctx.scale(-1, 1);
					ctx.translate(-80,0);
				}
			}
			Eximo.drawSprite('basic-'+anim+'-legs.png', ctx);

			// We make a tinted version of the body with CanvasDye
			ctx.drawImage(dyeImageWithColor(Eximo.getSprite('basic-'+anim+'-body.png'), this.color, 0.7), 0, 0);

			Eximo.drawSprite('basic-'+anim+'-head.png', ctx);
			this.spriteCache[this.animFrame] = this.sprite;
		} else this.sprite = this.spriteCache[this.animFrame];	
	};

	function mainLoop() {
		requestAnimFrame(mainLoop);
		mainLogic();
		mainRender();
	}

	function mainLogic () {
		for (var i = 0; i < gameObjects.length; ++i) {
			gameObjects[i].logic();
		}
	}

	function mainRender() {
		ctx.clearRect(0,0,canvas.width,canvas.height);
		ctx.save();
		ctx.translate(w/2, h/2);
		for (var i = 0; i < gameObjects.length; ++i) {
			gameObjects[i].render(ctx);
		}
		ctx.restore();
	}

	//Initial adjustment to screen
	resize();

	</script>
</body>
</html>